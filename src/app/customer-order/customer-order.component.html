<!-- Master-Detail Form Template -->
<ng-container *ngIf="metadata as page">
  <div class="master-detail-container">
    
    <!-- Header Section -->
    <div class="form-header">
      <h1 class="form-title">{{ page.title }}</h1>
      <p class="form-subtitle">Quản lý thông tin khách hàng và đơn hàng</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
      <div class="tab-nav">
        <div *ngFor="let tab of page.tabs; let i = index" 
             class="tab-button"
             [class.active]="selectedTab === i"
             (click)="selectedTab = i">
          {{ tab.title }}
        </div>
      </div>
    </div>

    <!-- Master Form Section -->
    <form (ngSubmit)="onSubmit()" *ngIf="page.tabs[selectedTab]?.form as form" class="master-form">
      <h2 class="master-form-title">{{ form.title }}</h2>

      <div class="form-grid">
        <div *ngFor="let field of form.fields" 
             class="form-group"
             [class.full-width]="field.type === 'textarea'"
             [class.half-width]="field.type !== 'textarea'">
          
          <label class="form-label" [class.required]="field.required">
            {{ field.label }}
          </label>

          <!-- Text, Email, Number inputs -->
          <input
            *ngIf="['text', 'email', 'number'].includes(field.type)"
            [type]="field.type"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            [min]="field.min"
            [max]="field.max"
            [placeholder]="field.placeholder || 'Nhập ' + field.label.toLowerCase()"
            class="form-input"
            [(ngModel)]="formData[field.key]" />

          <!-- Date input -->
          <input
            *ngIf="field.type === 'date'"
            type="date"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            [placeholder]="field.placeholder || 'Chọn ' + field.label.toLowerCase()"
            class="form-input"
            [(ngModel)]="formData[field.key]" />

          <!-- Textarea -->
          <textarea
            *ngIf="field.type === 'textarea'"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            [rows]="field.rows || 3"
            [placeholder]="field.placeholder || 'Nhập ' + field.label.toLowerCase()"
            class="form-textarea"
            [(ngModel)]="formData[field.key]">
          </textarea>

          <!-- Select dropdown -->
          <select
            *ngIf="field.type === 'select'"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            class="form-select"
            [(ngModel)]="formData[field.key]">
            <option value="">-- Chọn {{ field.label.toLowerCase() }} --</option>
            <option *ngFor="let opt of field.options || []" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>

          <!-- Lookup field with button -->
          <div *ngIf="field.type === 'lookup'" class="form-lookup">
            <input
              type="text"
              [name]="field.key"
              [required]="!!field.required"
              [disabled]="!!field.disabled"
              [placeholder]="field.placeholder || 'Tìm kiếm ' + field.label.toLowerCase()"
              class="form-input"
              [(ngModel)]="formData[field.key]" />
            <button type="button" class="form-lookup-button">
              <span>+</span>
            </button>
          </div>

          <!-- Error message -->
          <div *ngIf="getFieldError(field.key)" class="error-message">
            {{ getFieldError(field.key) }}
          </div>
        </div>
      </div>

      <!-- Form Actions -->
       <div class="form-actions">
        <button type="button" class="btn-modern btn-danger btn-small">Hủy</button>
        <button type="button" class="btn-modern btn-secondary btn-small">Lưu nháp</button>
        <button type="submit" class="btn-modern btn-success btn-small">Lưu</button>
      </div>
    </form>

    <!-- Detail Section -->
    <div *ngIf="page.tabs[selectedTab]?.detail as detail" class="detail-section">
      
      <!-- Detail Header -->
      <div class="detail-header">
        <h3 class="detail-title">{{ detail.title || 'Chi tiết đơn hàng' }}</h3>
        <div class="detail-actions">
          <button type="button" class="btn-add" (click)="addDetailRow()">
            + Thêm dòng
          </button>
        </div>
      </div>

      <!-- Detail Table -->
      <div class="detail-table-container">
        <table class="detail-table">
          <thead>
            <tr>
              <th style="width: 40px;">#</th>
              <th *ngFor="let field of detail.fields" 
                  [style.width]="getColumnWidth(field.type)">
                {{ field.label }}
                <span *ngIf="field.required" class="text-red-500">*</span>
              </th>
              <th style="width: 80px;">Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of detailRows; let i = index; trackBy: trackByIndex">
              
              <!-- Row number -->
              <td class="text-center text-gray-500">{{ i + 1 }}</td>

              <!-- Detail fields -->
              <td *ngFor="let field of detail.fields">
                
                <!-- Text/Number inputs -->
                <input
                  *ngIf="['text', 'number'].includes(field.type)"
                  [type]="field.type"
                  [name]="field.key + '_' + i"
                  [min]="field.min"
                  [max]="field.max"
                  [step]="field.step"
                  [placeholder]="field.placeholder || field.label"
                  class="form-input w-full"
                  [(ngModel)]="row[field.key]"
                  (ngModelChange)="onDetailFieldChange(i, field.key, $event)" />

                <!-- Select dropdown -->
                <select
                  *ngIf="field.type === 'select'"
                  [name]="field.key + '_' + i"
                  class="form-select w-full"
                  [(ngModel)]="row[field.key]"
                  (ngModelChange)="onDetailFieldChange(i, field.key, $event)">
                  <option value="">--</option>
                  <option *ngFor="let opt of field.options || []" [value]="opt.value">
                    {{ opt.label }}
                  </option>
                </select>

                <!-- Date input -->
                <input
                  *ngIf="field.type === 'date'"
                  type="date"
                  [name]="field.key + '_' + i"
                  class="form-input w-full"
                  [(ngModel)]="row[field.key]"
                  (ngModelChange)="onDetailFieldChange(i, field.key, $event)" />

                <!-- Readonly/calculated fields -->
                <span
                  *ngIf="field.disabled"
                  class="text-right block">
                  {{ formatValue(row[field.key], field.type) }}
                </span>

              </td>

              <!-- Row actions -->
              <td>
                <div class="row-actions">
                  <button type="button" class="btn-modern btn-danger btn-small btn-icon" (click)="removeDetailRow(i)" title="Xóa">
                    ×
                  </button>
                </div>
              </td>
            </tr>

            <!-- Empty state -->
            <tr *ngIf="detailRows.length === 0">
              <td [attr.colspan]="detail.fields.length + 2" class="text-center text-gray-500 py-8">
                Chưa có dữ liệu. Nhấn "Thêm dòng" để bắt đầu.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Summary Section -->
      <div class="summary-section" *ngIf="shouldShowSummary()">
        <div class="summary-grid">
          <div class="summary-label">Tổng tiền hàng:</div>
          <div class="summary-value">{{ formatCurrency(calculateSubtotal()) }}</div>
          
          <div class="summary-label">Tiền thuế GTGT:</div>
          <div class="summary-value">{{ formatCurrency(calculateTax()) }}</div>
          
          <div class="summary-label">Tiền chiết khấu:</div>
          <div class="summary-value">{{ formatCurrency(calculateDiscount()) }}</div>
          
          <div class="summary-total">
            <div class="summary-label">Tổng tiền thanh toán:</div>
            <div class="summary-value">{{ formatCurrency(calculateTotal()) }}</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</ng-container>