<!-- Master-Detail Form Template with Column-Level Filtering -->
<ng-container *ngIf="metadata as page">
  <div class="master-detail-container">
    
    <!-- Header Section -->
    <div class="form-header">
      <h1 class="form-title">{{ page.title }}</h1>
      <p class="form-subtitle">Qu·∫£n l√Ω th√¥ng tin kh√°ch h√†ng v√† ƒë∆°n h√†ng</p>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-container">
      <div class="tab-nav">
        <div *ngFor="let tab of page.tabs; let i = index" 
             class="tab-button"
             [class.active]="selectedTab === i"
             (click)="selectedTab = i; onSelectChange()">
          {{ tab.title }}
        </div>
      </div>
    </div>

    <!-- Master Form Section -->
    <form (ngSubmit)="onSubmit()" *ngIf="page.tabs[selectedTab]?.form as form" class="master-form">
      <h2 class="master-form-title">{{ form.title }}</h2>

      <div class="form-grid">
        <div *ngFor="let field of form.fields" class="form-group">
          
          <label class="form-label" [class.required]="field.required">
            {{ field.label }}
          </label>

          <!-- Text, Email, Number inputs -->
          <input
            *ngIf="['text', 'email', 'number'].includes(field.type)"
            [type]="field.type"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            [min]="field.min"
            [max]="field.max"
            [placeholder]="field.placeholder || 'Nh·∫≠p ' + field.label.toLowerCase()"
            class="form-input"
            [(ngModel)]="formData[field.key]" />

          <!-- Date input -->
          <input
            *ngIf="field.type === 'date'"
            type="date"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            [placeholder]="field.placeholder || 'Ch·ªçn ' + field.label.toLowerCase()"
            class="form-input"
            [(ngModel)]="formData[field.key]" />

          <!-- Textarea -->
          <textarea
            *ngIf="field.type === 'textarea'"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            [rows]="field.rows || 3"
            [placeholder]="field.placeholder || 'Nh·∫≠p ' + field.label.toLowerCase()"
            class="form-textarea"
            [(ngModel)]="formData[field.key]">
          </textarea>

          <!-- Select dropdown -->
          <select
            *ngIf="field.type === 'select'"
            [name]="field.key"
            [required]="!!field.required"
            [disabled]="!!field.disabled"
            class="form-select"
            [(ngModel)]="formData[field.key]">
            <option value="">-- Ch·ªçn {{ field.label.toLowerCase() }} --</option>
            <option *ngFor="let opt of field.options || []" [value]="opt.value">
              {{ opt.label }}
            </option>
          </select>

          <!-- Lookup field with button -->
          <div *ngIf="field.type === 'lookup'" class="form-lookup">
            <input
              type="text"
              [name]="field.key"
              [required]="!!field.required"
              [disabled]="!!field.disabled"
              [placeholder]="field.placeholder || 'T√¨m ki·∫øm ' + field.label.toLowerCase()"
              class="form-input"
              [(ngModel)]="formData[field.key]" />
            <button type="button" class="form-lookup-button">
              <span>+</span>
            </button>
          </div>

          <!-- Error message -->
          <div *ngIf="getFieldError(field.key)" class="error-message">
            {{ getFieldError(field.key) }}
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn-modern btn-danger btn-small">H·ªßy</button>
        <button type="button" class="btn-modern btn-secondary btn-small">L∆∞u nh√°p</button>
        <button type="submit" class="btn-modern btn-success btn-small">L∆∞u</button>
      </div>
    </form>

    <!-- Detail Section -->
    <div *ngIf="page.tabs[selectedTab]?.detail as detail" class="detail-section">
      
      <!-- Detail Header with Summary Info -->
      <div class="detail-header">
        <h3 class="detail-title">
          {{ detail.title || 'Chi ti·∫øt ƒë∆°n h√†ng' }}
          <span class="text-sm text-gray-500 ml-2">
            ({{ filteredDetailRows.length }}/{{ detailRows.length }})
          </span>
        </h3>
        <div class="detail-actions flex items-center gap-2">
          <!-- Filter Mode Toggle -->
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">Ch·∫ø ƒë·ªô l·ªçc:</span>
            <button 
              type="button"
              class="btn-modern btn-small"
              [class.btn-success]="filterMode === 'all'"
              [class.btn-secondary]="filterMode !== 'all'"
              (click)="toggleFilterMode()"
              title="Ch·∫ø ƒë·ªô l·ªçc: {{ filterMode === 'all' ? 'T·∫•t c·∫£ ƒëi·ªÅu ki·ªán (AND)' : 'B·∫•t k·ª≥ ƒëi·ªÅu ki·ªán (OR)' }}">
              {{ filterMode === 'all' ? 'T·∫•t c·∫£ ƒëi·ªÅu ki·ªán (AND)' : 'B·∫•t k·ª≥ ƒëi·ªÅu ki·ªán (OR)' }}
            </button>
          </div>
          
          <!-- Clear All Filters Button -->
          <button 
            type="button" 
            class="btn-modern btn-warning btn-small"
            [disabled]="!hasActiveFilters()"
            (click)="clearAllFilters()"
            title="X√≥a t·∫•t c·∫£ b·ªô l·ªçc">
            üóëÔ∏è X√≥a b·ªô l·ªçc
            <span *ngIf="hasActiveFilters()" class="ml-1 bg-red-500 text-white rounded-full px-2 py-0.5 text-xs">
              {{ getActiveFilterCount() }}
            </span>
          </button>
          
          <!-- Add Row Button -->
          <button type="button" class="btn-modern btn-success btn-small" (click)="addDetailRow()">
            + Th√™m d√≤ng
          </button>
        </div>
      </div>

      <!-- Detail Table with Column Filters -->
      <div class="detail-table-container" *ngIf="detail.fields && detail.fields.length > 0; else noFieldsTemplate">
        <table class="detail-table">
          <thead>
            <!-- Column Headers -->
            <tr>
              <th style="width: 40px;">#</th>
              <th *ngFor="let field of detail.fields" 
                  [style.width]="getColumnWidth(field.type)">
                <div class="flex items-center justify-between">
                  <span>
                    {{ field.label }}
                    <span *ngIf="field.required" class="text-red-500">*</span>
                  </span>
                  <span 
                    *ngIf="columnFilters[field.key]" 
                    class="ml-2 text-blue-500 text-xs"
                    title="ƒêang l·ªçc: {{ columnFilters[field.key] }}">
                    üîç
                  </span>
                </div>
              </th>
              <th style="width: 80px;">Thao t√°c</th>
            </tr>
            
            <!-- Column Filters Row -->
            <tr class="bg-gray-50">
              <td class="p-1"></td>
              <td *ngFor="let field of detail.fields" class="p-1">
                <div class="relative" [hidden]="field.disabled">
                  
                  <!-- Text/Number Filter Input -->
                  <input
                    *ngIf="field.type !== 'select'"
                    type="text"
                    class="w-full text-xs border border-gray-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                    [(ngModel)]="columnFilters[field.key]"
                    (ngModelChange)="onFilterChange(field.key, $event)"
                    (keydown.enter)="applyFilters()" />
                  
                  <!-- Select Filter Dropdown -->
                  <select
                    *ngIf="field.type === 'select'"
                    class="w-full text-xs border border-gray-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                    [(ngModel)]="columnFilters[field.key]"
                    (ngModelChange)="onFilterChange(field.key, $event)">
                    <option value="">-- T·∫•t c·∫£ --</option>
                    <option *ngFor="let opt of field.options || []" [value]="opt.value">
                      {{ opt.label }}
                    </option>
                  </select>
                  
                  <!-- Clear Filter Button -->
                  <button
                    *ngIf="columnFilters[field.key]"
                    type="button"
                    class="absolute right-1 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-500 transition-colors text-xs"
                    (click)="clearFilter(field.key)"
                    title="X√≥a b·ªô l·ªçc">
                    √ó
                  </button>
                </div>
                
              
              </td>
              <td class="p-1"></td>
            </tr>
          </thead>
          
          <tbody>
            <!-- Data Rows -->
            <tr *ngFor="let row of filteredDetailRows; let i = index; trackBy: trackByIndex"
                class="hover:bg-blue-50">
              
              <!-- Row number -->
              <td class="text-center text-gray-500">{{ row.item_id || (i + 1) }}</td>

              <!-- Detail fields -->
              <td *ngFor="let field of detail.fields">
                
                <!-- Text/Number inputs -->
                <input
                  *ngIf="['text', 'number'].includes(field.type) && !field.disabled"
                  [type]="field.type"
                  [name]="field.key"
                  [min]="field.min"
                  [max]="field.max"
                  [step]="field.step"
                  class="form-input w-full text-sm"
                  [(ngModel)]="row[field.key]"
                  (ngModelChange)="onDetailFieldChange(i, field.key, $event)" />

                <!-- Select dropdown -->
                <!--<select
                  *ngIf="field.type === 'select' && !field.disabled"
                  [name]="field.key + '_' + i"
                  class="form-select w-full text-sm"
                  [(ngModel)]="row[field.key]"
                  (ngModelChange)="onDetailFieldChange(i, field.key, $event)">
                  <option value="">--</option>
                  <option *ngFor="let opt of field.options || []" [value]="opt.value">
                    {{ opt.label }}
                  </option>
                </select>-->

                <!-- Date input -->
                <!--<input
                  *ngIf="field.type === 'date' && !field.disabled"
                  type="date"
                  [name]="field.key + '_' + i"
                  class="form-input w-full text-sm"
                  [(ngModel)]="row[field.key]"
                  (ngModelChange)="onDetailFieldChange(i, field.key, $event)" />
              -->
                <!-- Readonly/calculated fields (non-select) -->
                <span
                  *ngIf="field.disabled && field.type !== 'select'"
                  class="text-right block font-medium text-sm"
                  [ngClass]="{'text-green-600 font-bold': field.key === 'total'}">
                  {{ formatFieldValue(row, field) }}
                </span>

                <!-- Display select fields (like product) -->
                <div
                  *ngIf="field.type === 'select'"
                  class="text-sm">
                  
                  
                  <!-- Regular select field display -->
                  <span *ngIf="field.key !== 'product'">
                    {{ getOptionLabel(field.key, row[field.key]) }}
                  </span>
                </div>

              </td>

              <!-- Row actions -->
              <td>
                <div class="row-actions">
                  <button type="button" 
                          class="btn-modern btn-danger btn-small" 
                          (click)="removeDetailRow(i)" 
                          title="X√≥a">
                    √ó
                  </button>
                </div>
              </td>
            </tr>

            <!-- Empty state - original data is empty -->
            <tr *ngIf="filteredDetailRows.length === 0 && detailRows.length === 0">
              <td [attr.colspan]="detail.fields.length + 2" class="text-center text-gray-500 py-8">
                Ch∆∞a c√≥ d·ªØ li·ªáu. Nh·∫•n "Th√™m d√≤ng" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
              </td>
            </tr>

            <!-- No results after filtering -->
            <tr *ngIf="filteredDetailRows.length === 0 && detailRows.length > 0">
              <td [attr.colspan]="detail.fields.length + 2" class="text-center text-yellow-600 py-8">
                <div class="flex flex-col items-center gap-2">
                  <span>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p v·ªõi b·ªô l·ªçc.</span>
                  <button 
                    type="button" 
                    class="btn-modern btn-warning btn-small"
                    (click)="clearAllFilters()">
                    üóëÔ∏è X√≥a t·∫•t c·∫£ b·ªô l·ªçc
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Fields Template -->
      <ng-template #noFieldsTemplate>
        <div class="text-center py-8 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-gray-600 mb-4">Kh√¥ng t√¨m th·∫•y ƒë·ªãnh nghƒ©a tr∆∞·ªùng d·ªØ li·ªáu.</p>
          <button 
            type="button" 
            class="btn-modern btn-primary btn-small"
            (click)="loadInitialDetailData()">
            üîÑ T·∫£i l·∫°i d·ªØ li·ªáu
          </button>
        </div>
      </ng-template>

      <!-- Summary Section with Enhanced Calculations -->
      <div class="summary-section" *ngIf="shouldShowSummary()">
        <!-- Filter Status Info -->
        <div *ngIf="hasActiveFilters()" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-blue-700 font-medium">üîç ƒêang √°p d·ª•ng b·ªô l·ªçc:</span>
              <span class="text-blue-600">{{ getActiveFilterCount() }} ƒëi·ªÅu ki·ªán</span>
              <span class="text-sm text-blue-600">({{ filterMode === 'all' ? 'T·∫•t c·∫£' : 'B·∫•t k·ª≥' }})</span>
            </div>
            <button 
              type="button" 
              class="btn-modern btn-warning btn-small"
              (click)="clearAllFilters()">
              X√≥a b·ªô l·ªçc
            </button>
          </div>
          
          <!-- Active filters display -->
          <div class="mt-2 flex flex-wrap gap-2">
            <span *ngFor="let field of detail.fields" 
                  class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs"
                  [hidden]="!columnFilters[field.key]">
              <strong>{{ field.label }}:</strong>
              <span>{{ columnFilters[field.key] }}</span>
              <button 
                type="button" 
                class="ml-1 text-blue-500 hover:text-red-500"
                (click)="clearFilter(field.key)">
                √ó
              </button>
            </span>
          </div>
        </div>

        <!-- Total Summary (All Data) -->
        <div class="summary-grid mb-4">
          <div class="text-lg font-semibold text-gray-800 col-span-2 mb-2 border-b border-gray-300 pb-2">
            üìä T·ªïng k·∫øt t·∫•t c·∫£ d·ªØ li·ªáu ({{ detailRows.length }} d√≤ng)
          </div>
          
          <div class="summary-label">S·ªë m·∫∑t h√†ng:</div>
          <div class="summary-value">{{ detailRows.length }} s·∫£n ph·∫©m</div>
          
          <div class="summary-label">T·ªïng s·ªë l∆∞·ª£ng:</div>
          <div class="summary-value">{{ formatNumber(calculateTotalQuantity()) }}</div>
          
          <div class="summary-label">T·ªïng ti·ªÅn h√†ng:</div>
          <div class="summary-value">{{ formatCurrency(calculateSubtotal()) }}</div>
          
          <div class="summary-label">Ti·ªÅn chi·∫øt kh·∫•u:</div>
          <div class="summary-value">{{ formatCurrency(calculateDiscount()) }}</div>
          
          <div class="summary-label">Ti·ªÅn thu·∫ø GTGT (10%):</div>
          <div class="summary-value">{{ formatCurrency(calculateTax()) }}</div>
          
          <div class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn:</div>
          <div class="summary-value">{{ formatCurrency(formData['shipping_fee'] || 0) }}</div>
          
          <div class="summary-total">
            <div class="summary-label">T·ªïng ti·ªÅn thanh to√°n:</div>
            <div class="summary-value">{{ formatCurrency(calculateTotal()) }}</div>
          </div>
        </div>

        <!-- Filtered Summary (if filters are active) -->
        <div *ngIf="hasActiveFilters() && filteredDetailRows.length > 0" 
             class="summary-grid border-t-2 border-blue-200 pt-4 bg-blue-50 rounded-lg p-4">
          <div class="text-lg font-semibold text-blue-800 col-span-2 mb-2 border-b border-blue-300 pb-2">
            üîç T·ªïng k·∫øt d·ªØ li·ªáu ƒë√£ l·ªçc ({{ filteredDetailRows.length }} d√≤ng)
          </div>
          
          <div class="summary-label text-blue-700">S·ªë m·∫∑t h√†ng ƒë√£ l·ªçc:</div>
          <div class="summary-value text-blue-800">{{ filteredDetailRows.length }} s·∫£n ph·∫©m</div>
          
          <div class="summary-label text-blue-700">T·ªïng SL ƒë√£ l·ªçc:</div>
          <div class="summary-value text-blue-800">{{ formatNumber(calculateFilteredQuantity()) }}</div>
          
          <div class="summary-label text-blue-700">T·ªïng ti·ªÅn h√†ng ƒë√£ l·ªçc:</div>
          <div class="summary-value text-blue-800">{{ formatCurrency(calculateFilteredSubtotal()) }}</div>
          
          <div class="summary-total border-blue-300">
            <div class="summary-label text-blue-700">T·ª∑ l·ªá so v·ªõi t·ªïng:</div>
            <div class="summary-value text-blue-800">{{ calculateFilteredPercentage() }}%</div>
          </div>
          
          <!-- Comparison indicators -->
          <div class="col-span-2 mt-3 pt-3 border-t border-blue-300">
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div class="text-center">
                <div class="text-blue-600 font-medium">S·ªë l∆∞·ª£ng</div>
                <div class="text-blue-800 font-bold">
                  {{ formatNumber(calculateFilteredQuantity()) }} / {{ formatNumber(calculateTotalQuantity()) }}
                </div>
              </div>
              <div class="text-center">
                <div class="text-blue-600 font-medium">Gi√° tr·ªã</div>
                <div class="text-blue-800 font-bold">
                  {{ calculateFilteredPercentage() }}%
                </div>
              </div>
              <div class="text-center">
                <div class="text-blue-600 font-medium">D√≤ng d·ªØ li·ªáu</div>
                <div class="text-blue-800 font-bold">
                  {{ filteredDetailRows.length }} / {{ detailRows.length }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty filter result notice -->
        <div *ngIf="hasActiveFilters() && filteredDetailRows.length === 0" 
             class="summary-grid border-t-2 border-yellow-200 pt-4 bg-yellow-50 rounded-lg p-4">
          <div class="col-span-2 text-center text-yellow-700">
            <div class="text-lg font-semibold mb-2">‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p</div>
            <p class="text-sm mb-3">B·ªô l·ªçc hi·ªán t·∫°i kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o. H√£y th·ª≠:</p>
            <div class="flex flex-wrap justify-center gap-2">
              <button 
                type="button" 
                class="btn-modern btn-warning btn-small"
                (click)="clearAllFilters()">
                üóëÔ∏è X√≥a t·∫•t c·∫£ b·ªô l·ªçc
              </button>
              <button 
                type="button" 
                class="btn-modern btn-secondary btn-small"
                (click)="toggleFilterMode()">
                üîÑ ƒê·ªïi ch·∫ø ƒë·ªô l·ªçc ({{ filterMode === 'all' ? 'OR' : 'AND' }})
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</ng-container>